// back-end/prompts/1BAC/SX-SM/1BAC_SX-SM_ar/questionPrompt_1BAC_SX-SM_ar.js

function generatePracticeQuestionPrompt(context) {
    const {
        academicLevelName, // "1BAC"
        trackName,         // "SX-SM"
        subjectName,       // "اللغة العربية" أو "1BAC_SX-SM_ar"
        difficultyLevelApi,// "Facile", "Moyen", "Difficile"
        selectedLessonTitre, // عنوان الدرس المختار (قد يكون من مكون النصوص، علوم اللغة، أو التعبير والإنشاء)
        selectedParagraphTexte, // تفاصيل إضافية حول الدرس أو جزء منه
        questionLanguage,  // "ar" في هذه الحالة
        questionTypeToGenerate, // "mcq" أو "free_text"
        selectedTaskFlavor,
        lessonForJsonOutput 
    } = context;

    const languageInstruction = "السؤال وجميع أجزائه (النص، الخيارات، الإجابة الصحيحة) يجب أن تكون حصريًا باللغة العربية الفصحى السليمة والمناسبة للسياق الأكاديمي المغربي (مستوى أولى باكالوريا).";

    const promptExpertise = `خبير في صياغة أسئلة مادة اللغة العربية للمستوى الثانوي التأهيلي (الأولى باكالوريا - ${trackName}) وفق المنهاج المغربي.`;

    let examStyleGuidance = `
السؤال المُنشأ يجب أن يحاكي بدقة أسلوب وبنية ومتطلبات الأسئلة النموذجية في الامتحانات الجهوية لمادة اللغة العربية للمستوى ${academicLevelName} - ${trackName}.
يجب أن يركز السؤال على تقييم:
- الفهم الدقيق للمفاهيم والقضايا الأدبية والنقدية واللغوية.
- القدرة على تطبيق المعارف والمهارات في سياقات جديدة.
- مهارات التحليل والتفكير النقدي.
- الدقة في التعريفات والشروحات اللغوية والأدبية.
يجب أن يكون السؤال مبنيًا على "الدرس المحدد" و "المحتوى التفصيلي" المقدم.
لغة السؤال وجميع مكوناته يجب أن تكون باللغة العربية الفصحى.
`;

    if (difficultyLevelApi === "Difficile") {
        examStyleGuidance += "هذا السؤال يجب أن يكون ذا مستوى صعوبة عالٍ، وقد يتطلب تحليلًا عميقًا، أو ربطًا بين عدة مفاهيم، أو تطبيق مهارات لغوية دقيقة.";
    } else if (difficultyLevelApi === "Moyen") {
        examStyleGuidance += "هذا السؤال يجب أن يتطلب قدرًا من التفكير التحليلي أو تطبيق المعرفة، متجاوزًا الاستظهار البسيط. يجب أن يكون متوسط الصعوبة كما في الامتحانات الجهوية.";
    } else { // Facile
        examStyleGuidance += "هذا السؤال يجب أن يختبر الفهم الأساسي والتعرف المباشر على المفاهيم الرئيسية من الدرس، مشابهًا للأسئلة المباشرة في الامتحانات الجهوية.";
    }

    let contextForPrompt = typeof selectedParagraphTexte === 'string' ? selectedParagraphTexte : JSON.stringify(selectedParagraphTexte);
    const MAX_CONTEXT_LENGTH = 1200;
    if (contextForPrompt.length > MAX_CONTEXT_LENGTH) {
        contextForPrompt = contextForPrompt.substring(0, MAX_CONTEXT_LENGTH) + "... (تم اقتطاع المحتوى)";
    }

    const topicContextBlock = `
السياق_الأكاديمي:
- المستوى: "${academicLevelName}"
- المسلك: "${trackName}"
- المادة: "${subjectName}"
- الدرس_المحدد_للسؤال / المحور: "${selectedLessonTitre}" 
- المحتوى_التفصيلي_للسؤال / المفهوم_الفرعي: "${contextForPrompt}"
- لغة_السؤال: "${questionLanguage}"`;

    let outputFormatInstructions;
    if (questionTypeToGenerate === "mcq") {
        outputFormatInstructions = `
صيغة_الإخراج_JSON_الدقيقة (سؤال متعدد الاختيارات QCM):
1.  ${languageInstruction}
2.  الهدف من المهمة: "${selectedTaskFlavor.description}". قم بإنشاء سؤال يعكس هذا الهدف.
3.  الصيغة: سؤال متعدد الاختيارات مع أربعة (4) خيارات مميزة ومقبولة بالضبط. يجب أن تكون الخيارات كاملة وصحيحة لغويًا.
4.  الإجابة_الصحيحة: يجب أن تكون هناك إجابة واحدة صحيحة بشكل لا لبس فيه. حقل "correctAnswer" في JSON يجب أن يكون مطابقًا تمامًا لنص أحد الخيارات المقدمة.
5.  المشتتات: جميع الخيارات، وخاصة الخاطئة (المشتتات)، يجب أن تكون ذات صلة بالموضوع ومقبولة لطالب في هذا المستوى. تجنب الخيارات التافهة أو الخاطئة بشكل واضح.
6.  نص_السؤال: يجب أن يكون واضحًا ودقيقًا، ويختبر مباشرة الهدف التعليمي من نكهة المهمة وسياق الدرس المقدم. قد يكون السؤال مبنيًا على مقتطف نصي قصير (إذا كان ذلك مناسبًا لنكهة المهمة والدرس) يمكنك تضمينه في نص السؤال.
7.  حقل "lesson": يجب أن يُملأ بتمثيل موجز لـ "${lessonForJsonOutput}".
8.  حقل "type": يجب أن يكون "mcq".
أجب فقط بكائن JSON واحد صالح، مُضمَّن في \`\`\`json ... \`\`\`. لا مقدمات أو اعتذارات.
\`\`\`json
{
  "question": "نص سؤال QCM بأسلوب الامتحان الجهوي هنا...",
  "options": ["نص الخيار أ", "نص الخيار ب", "نص الخيار ج", "نص الخيار د"],
  "correctAnswer": "النص الدقيق للخيار الصحيح",
  "lesson": "${lessonForJsonOutput}",
  "type": "mcq"
}
\`\`\`
`;
    } else { // free_text
        outputFormatInstructions = `
صيغة_الإخراج_JSON_الدقيقة (سؤال مفتوح الإجابة):
1.  ${languageInstruction}
2.  الهدف من المهمة: "${selectedTaskFlavor.description}". قم بإنشاء سؤال يعكس هذا الهدف.
3.  طبيعة_السؤال: يجب أن يتطلب السؤال إجابة نصية (مثل تحليل قصير، شرح مفهوم، تطبيق قاعدة لغوية مع مثال، تحديد خصائص). يمكن أن يطلب من التلميذ استخراج عنصر من نص ستقدمه في السؤال نفسه إذا لزم الأمر.
4.  حقل "options": يجب أن يكون مصفوفة فارغة [].
5.  حقل "correctAnswer": قدم إجابة نموذجية موجزة ودقيقة، أو النقاط الرئيسية المتوقعة. بالنسبة للأسئلة التحليلية، يمكن أن يكون هذا هو التفسير المتوقع. هذه الإجابة النموذجية ضرورية للتحقق اللاحق بواسطة الذكاء الاصطناعي.
6.  نص_السؤال: يجب أن يكون واضحًا ودقيقًا، ومناسبًا للمستوى والصعوبة المحددين، محاكيًا لأسلوب أسئلة الإجابة المفتوحة في الامتحان الجهوي.
7.  حقل "lesson": يجب أن يُملأ بتمثيل موجز لـ "${lessonForJsonOutput}".
8.  حقل "type": يجب أن يكون "free_text".
أجب فقط بكائن JSON واحد صالح، مُضمَّن في \`\`\`json ... \`\`\`. لا مقدمات أو اعتذارات.
\`\`\`json
{
  "question": "نص السؤال المفتوح بأسلوب الامتحان الجهوي هنا...",
  "options": [],
  "correctAnswer": "إجابة نموذجية، أو نقاط رئيسية، أو تفسير متوقع، كما في سلم تنقيط الامتحان.",
  "lesson": "${lessonForJsonOutput}",
  "type": "free_text"
}
\`\`\`
`;
    }

    const finalPrompt = `
أنت ${promptExpertise}.
مهمتك هي إنشاء سؤال واحد عالي الجودة، قابل للاستخدام مباشرة لتدريب وتقييم التلاميذ.

إرشادات_أسلوب_الامتحان_الجهوي:
${examStyleGuidance}

مهمة_إنشاء_السؤال:
- نكهة المهمة (ID): ${selectedTaskFlavor.id} (نوع المخرج المستهدف: ${selectedTaskFlavor.type})

${topicContextBlock}

${outputFormatInstructions}

تعليمات_نهائية: راجع بعناية كائن JSON المُنشأ للتأكد من أنه صالح، وأنه يلتزم بجميع التعليمات، وأن كل النصوص باللغة المحددة: ${questionLanguage}. يجب أن يكون السؤال مستمدًا مباشرة من "المحتوى_التفصيلي_للسؤال / المفهوم_الفرعي" المقدم.
إذا كانت "نكهة المهمة" تتضمن تحليل نص، ولم يكن "المحتوى التفصيلي" مقتطفًا مناسبًا، يمكنك إنشاء مقتطف قصير ذي صلة (2-4 أسطر) لتضمينه داخل حقل "question" في JSON، متبوعًا بالسؤال نفسه.
`;
    return finalPrompt;
}

module.exports = {
    generatePracticeQuestionPrompt
};